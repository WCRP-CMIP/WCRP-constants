<<<<<<< HEAD
name: ↻ Sync Workflows
description: Sync shared workflows and files from main to other branches

permissions:
  contents: write
=======
name: → workflows
>>>>>>> fabd696 (Initial commit)

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**'
<<<<<<< HEAD

      - '.github/prepublish/**'

      - '.github/CONTRIBUTING.md'
  workflow_dispatch:

env:
  SYNC_FOLDERS: "workflows prepublish"
  SYNC_FILES: "CONTRIBUTING.md"
=======
      - '.github/prepublish/*'
      - '.github/ISSUE_SCRIPT/**'
      - '.github/*.md'

  workflow_dispatch:

permissions:
  contents: write
>>>>>>> fabd696 (Initial commit)

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
<<<<<<< HEAD
        branch:

          - src-data

          - docs

    
    steps:
      - name: Checkout target branch
=======
        branch: 
          - src-data
          - docs
    
    steps:
      - name: Checkout branch
>>>>>>> fabd696 (Initial commit)
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0
<<<<<<< HEAD
      
      - name: Fetch main branch
        run: git fetch origin main --depth=1

      - name: Sync folders from main
        run: |
          for folder in $SYNC_FOLDERS; do
            echo "Syncing folder: .github/$folder"
            mkdir -p ".github/$folder"
            if git ls-tree -r origin/main --name-only | grep -q "^.github/$folder/"; then
              git checkout origin/main -- ".github/$folder/" 2>/dev/null || \
                echo "  ⚠ Folder .github/$folder not found on main"
            else
              echo "  ⚠ Folder .github/$folder not found on main"
            fi
          done

      - name: Sync files from main
        run: |
          for file in $SYNC_FILES; do
            echo "Syncing file: .github/$file"
            if git cat-file -e "origin/main:.github/$file" 2>/dev/null; then
              git checkout origin/main -- ".github/$file"
            else
              echo "  ⚠ File .github/$file not found on main"
            fi
          done
      
      - name: Commit and push changes
=======
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Copy files from main
        run: |
          mkdir -p .github/workflows
          mkdir -p .github/prepublish
          mkdir -p .github/ISSUE_SCRIPT

          # Ensure remote main is available (works in detached HEAD)
          git fetch origin main --depth=1 || true

          # Copy workflows directory from remote main if present
          git checkout origin/main -- .github/workflows/ || true

          # Copy prepublish directory from remote main if present
          git checkout origin/main -- .github/prepublish/ || true

          # Copy ISSUE_SCRIPT directory from remote main if present
          git checkout origin/main -- .github/ISSUE_SCRIPT/ || true
          
          # Copy all .md files from .github
          for f in $(git ls-tree --name-only origin/main .github/ | grep '\.md$'); do
            git checkout origin/main -- "$f" || true
          done
      
      - name: Commit and push
>>>>>>> fabd696 (Initial commit)
        uses: EndBug/add-and-commit@v9
        with:
          add: '.github/'
          author_name: 'cmip-ipo'
          author_email: 'actions@wcrp-cmip.org'
          message: 'Sync .github files from main'
          push: true
