name: âˆ† src-data
<<<<<<< HEAD
description: Sync and process data from src-data to production

permissions:
  contents: write
  pages: write
  id-token: write

=======
description: Sync JSON and @context changes from src-data to production, applying relevant updates.
permissions:
  contents: write
  pages: write
  actions: write
  id-token: write
>>>>>>> fabd696 (Initial commit)
on:
  push:
    branches:
      - "src-data"
  workflow_dispatch:
<<<<<<< HEAD

jobs:
  sync_and_process:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
    
    steps:
=======
    inputs:
      debug:
        description: 'Enable debug output'
        required: false
        default: 'false'
        type: boolean
jobs:
  sync_to_production:
    runs-on: ubuntu-latest
    steps:
          
>>>>>>> fabd696 (Initial commit)
      - name: Checkout production branch
        uses: actions/checkout@v4
        with:
          ref: production
          fetch-depth: 0
<<<<<<< HEAD
          
      - name: Fetch src-data branch
        run: |
          git fetch origin src-data:src-data

      - name: Install CMIPLD
        run: |
          npm i -g jsonld-recursive
          pip install git+https://github.com/WCRP-CMIP/CMIPLD.git

      - name: Configure Git
        run: |
          git config user.name "cmip-ipo"
          git config user.email "actions@wcrp-cmip.org"

      - name: Clean production (keep docs and summaries)
        run: |
          shopt -s extglob dotglob
          rm -rf -- !(docs|summaries|.git|.github) || true
          echo "âœ“ Cleaned production branch"

      - name: Copy from src-data branch
        run: |
          echo "Restoring files from src-data..."
          git restore --source origin/src-data --staged --worktree -- . || true
          
          echo "âœ“ Copied from src-data"


      - name: Find vocabulary directories
        id: find_dirs
        run: |
          echo "Scanning for vocabulary directories..."
          
          dirs=()
          for dir in */; do
            dir="${dir%/}"
            
            if [[ "$dir" == "docs" || "$dir" == "summaries" || "$dir" == ".github" || "$dir" == "project" ]]; then
              continue
            fi
            
            if [ -f "$dir/_context" ]; then
              dirs+=("$dir")
              echo "  Found: $dir"
            fi
          done
          
          if [ ${#dirs[@]} -eq 0 ]; then
            echo "dirs_json=[]" >> $GITHUB_OUTPUT
            echo "No vocabulary directories found"
          else
            dirs_json=$(printf '%s\n' "${dirs[@]}" | jq -R . | jq -s -c .)
            echo "dirs_json=$dirs_json" >> $GITHUB_OUTPUT
            echo "Found ${#dirs[@]} directories"
          fi


      - name: Generate graphs
        if: steps.find_dirs.outputs.dirs_json != '[]'
        run: |
          echo "## Graph Generation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Directory | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          
          dirs=${{ steps.find_dirs.outputs.dirs_json }}
          
          echo "$dirs" | jq -r '.[]' | while read -r dir; do
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Processing: $dir"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            if [ ! -d "$dir" ]; then
              echo "Directory not found"
              echo "| $dir | âš ï¸ | Not found |" >> $GITHUB_STEP_SUMMARY
              continue
            fi
            
            if (cd "$dir" && ld2graph "."); then
              echo "Graph generated"
              
              if [ -f "$dir/graph.jsonld" ]; then
                tr -d '[:space:]' < "$dir/graph.jsonld" > "$dir/graph.min.json"
                cp "$dir/graph.min.json" "$dir/graph"
                cp "$dir/graph.min.json" "$dir/graph.json"
                git add "$dir"/graph* || true
                echo "Variants created"
                echo "| $dir | âœ… | Success |" >> $GITHUB_STEP_SUMMARY
              else
                echo "No output file"
                echo "| $dir | âš ï¸ | No file |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "Generation failed"
              echo "| $dir | âŒ | Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          done




      - name: Run prepublish scripts
        run: |
          if [ ! -d ".github/prepublish" ]; then
            echo "No prepublish directory"
            exit 0
          fi
          
          for script in .github/prepublish/*.sh; do
            if [ -f "$script" ]; then
              echo "Running: $(basename $script)"
              chmod +x "$script"
              bash "$script" || echo "Script failed"
            fi
          done



      - name: Build documentation from docs branch
        run: |
          echo "Fetching docs branch..."
          git fetch origin docs:docs
          
          echo "Copying docs to production..."
          rm -rf docs
          git restore --source origin/docs --staged --worktree -- docs/ || true
          
          echo "âœ“ Documentation updated"

=======
          persist-credentials: true

      - name: Clean production except docs and summaries
        run: |
          shopt -s extglob dotglob
          rm -rf -- !(docs|summaries|.git|.github) || true
          find .* -maxdepth 0 -type f -exec rm -f {} +

      - name: Restore path from src-data branch
        uses: WCRP-CMIP/CMIPLD/actions/fetch_branch_path@main
        with:
          branch: "src-data"
          path: ./
          remove: false

      - name: Verify restore and prepare changes
        run: |

          # git fetch origin src-data
          find .* -maxdepth 0 -type f -exec rm -f {} +

          git add -A
>>>>>>> fabd696 (Initial commit)

      - name: Check for changes
        id: check_changes
        run: |
<<<<<<< HEAD
          git add -A
          
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git commit -m "Sync from src-data and docs"
          git push origin production


  deploy:
    needs: sync_and_process
    if: needs.sync_and_process.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: production
      - uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      - uses: actions/deploy-pages@v4
        id: deployment
      - name: Display URL
        run: |
          echo "## ðŸš€ Deployed" >> $GITHUB_STEP_SUMMARY
          echo "URL: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY

=======
          git config user.name "cmip-ipo"
          git config user.email "actions@wcrp-cmip.org"
          
          git reset HEAD -- . || true
          git add -A
          
          if git diff --cached --quiet; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            if ! git diff --quiet HEAD origin/src-data; then
              git checkout origin/src-data -- ./ || true
              git add -A
              if ! git diff --cached --quiet; then
                echo "no_changes=false" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push Changes
        if: steps.check_changes.outputs.no_changes == 'false'
        uses: EndBug/add-and-commit@v9
        with:
          add: './**/**'
          author_name: 'cmip-ipo'
          author_email: 'actions@wcrp-cmip.org'
          message: 'Clean file upload from src-data'
          branch: production
          push: true
          
  graph:
    uses: WCRP-CMIP/CMIPLD/.github/workflows/graph.yml@main
    needs: sync_to_production
    with:
      updated: false
    
  publish-pages:
    if: always()
    needs:
      - graph
    uses: WCRP-CMIP/CMIPLD/.github/workflows/pages.yml@main
    with:
      branch: production
      force: true
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}

  generate-summaries:
    uses: WCRP-CMIP/CMIPLD/.github/workflows/summarise.yml@main
    with:
      output-path: './content_summaries/'
>>>>>>> fabd696 (Initial commit)
